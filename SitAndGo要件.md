# Sit and Go 要件（最小版）

## 基本仕様
- **参加人数**: 4人固定（4人揃わないと開始しない）
- **形式**: 単テーブル完結
- **想定時間**: 約20分
- **開始スタック**: 1500チップ（倍率により調整）

### タイムバンク
- **デフォルト持ち時間**: 15秒（毎ターンリセット、放置時は減少）
- **アディショナル持ち時間**: 上限15秒（毎ターン+5秒追加、持ち越し可）
- **放置ペナルティ**: -5秒/回（デフォルト持ち時間から減算、最小0秒）
- **復活**: アクション実行でデフォルト15秒に復活、afkCountリセット

### GUI情報表示
プレイ中はチャットが見えないため、GUI内に全情報を表示:
- **スロット18**: 次レベルまでの時間（CLOCK）
- **スロット19**: 現在のブラインド（GOLD_NUGGET）
- **スロット26**: 自分のレート（EXPERIENCE_BOTTLE）
- **スロット27**: 倍率・賞金プール（SUNFLOWER）

### イベント処理
- **インベントリを閉じる**: 何もしない（参加扱い継続、既存テキサスと同様）
- **プレイヤー切断**: 自動フォールド
- **脱落メッセージ**: 表示なし（最終結果のみ表示）

## マルチプライヤー（倍率）システム

### 基本ルール
- トーナメント開始時にランダムで倍率を決定
- 賞金プール = `buyIn × multiplier`（1人当たり表記）
- **レーキなし**（期待値 = 4）
- **最低保証**: バイインの2.5倍

### ルーレット演出（出来レース）
4人揃った時点で内部的に倍率は確定済み。演出としてルーレットを回す。

**リール配置（1周に全アイテム配置）:**
| アイテム | 倍率 | 見た目 |
|---|---|---|
| 銅インゴット | 2.5x, 3.0x, 3.5x, 4.0x | 低倍率ゾーン |
| 金インゴット | 4.0x, 5.0x | 中倍率ゾーン |
| 金ブロック | 6.0x, 8.0x | 高倍率ゾーン |
| ダイヤモンド | 10.0x | レア |
| ダイヤモンドブロック | 15.0x | 超レア |
| ネザースター | 20.0x | 激レア |

**演出フロー:**
1. ルーレット開始 → 高速回転（カチカチ音）
2. 徐々に減速（音も遅くなる）
3. 確定済みの倍率位置で停止
4. 停止アイテムに応じたエフェクト表示
5. ゲーム開始

**実装メモ:**
- 内部で `pickMultiplier()` 実行後にルーレット演出開始
- 停止位置は事前計算（出来レース）

### 倍率範囲（1人当たり）
2.5x, 3.0x, 3.5x, 4.0x, 5.0x, 6.0x, 8.0x, 10.0x, 15.0x, 20.0x

### 重みテーブル（%表記）
```
2.5x:  17.3% 
3.0x:  14.6%  
3.5x:  13.5%  
4.0x:  39.0%  
5.0x:   7.0%  
6.0x:   3.7%  
8.0x:   2.0%  
10.0x:  1.9% 
15.0x:  0.7% 
20.0x:  0.3% 
```
期待値: 2.5×0.173 + 3.0×0.146 + 3.5×0.135 + 4.0×0.39 + 5.0×0.07 + 6.0×0.037 + 8.0×0.02 + 10.0×0.019 + 15.0×0.007 + 20.0×0.003 = 3.99

## 賞金配分ルール

### 基本原則
- **4位**: 常に0
- **3位**: 10.0x以上のときのみ支払い
- **上位寄せ**: 低倍率は1位に集中、10x以上で若干分配

### 配分率
- **倍率 < 10.0x**:
- 1位: 70%
- 2位: 30%
- 3位: 0%
- 4位: 0%

- **10.0x以上**:
- 1位: 60%
- 2位: 30%
- 3位: 10%
- 4位: 0%

## 配分サンプル（buyIn = 100）

| 倍率 | プール | 1位 | 2位 | 3位 | 4位 |
|---:|---:|---:|---:|---:|---:|
| 2.5x | 250 | 175 | 75 | 0 | 0 |
| 3.0x | 300 | 200 | 100 | 0 | 0 |
| 3.5x | 350 | 250 | 100 | 0 | 0 |
| 4.0x | 400 | 280 | 120 | 0 | 0 |
| 5.0x | 500 | 350 | 150 | 0 | 0 |
| 6.0x | 600 | 420 | 180 | 0 | 0 |
| 8.0x | 800 | 550 | 250 | 0 | 0 |
| 10.0x | 1,000 | 600 | 300 | 100 | 0 |
| 15.0x | 1,500 | 900 | 450 | 150 | 0 |
| 20.0x | 2,000 | 1,200 | 600 | 200 | 0 |

## 開始スタック調整（BB換算）
倍率が高いほどスタックを深くし、技術が反映されやすくする。

- 2.5x -> 20BB
- 3.0x -> 25BB
- 3.5x -> 30BB
- 4.0x -> 30BB
- 5.0x -> 35BB
- 6.0x -> 40BB
- 8.0x -> 50BB
- 10.0x -> 60BB
- 15.0x -> 80BB
- 20.0x -> 100BB

## 実装要点

### データベース
既存 `gameLog` に以下を追加:
```sql
ALTER TABLE gameLog
  ADD COLUMN isTournament BOOLEAN DEFAULT FALSE,
  ADD COLUMN multiplier DOUBLE DEFAULT 1.0,
  ADD COLUMN buyIn INT DEFAULT 0,
  ADD COLUMN prize1 INT DEFAULT 0,
  ADD COLUMN prize2 INT DEFAULT 0,
  ADD COLUMN prize3 INT DEFAULT 0,
  ADD COLUMN prize4 INT DEFAULT 0;
```

### クラス設計
`TexasHoldem` を継承した `SitAndGo.kt`:
- コンストラクタで `buyIn` を受け取る
- 開始時に `pickMultiplier()` で倍率決定
- `calculatePrize(position, multiplier)` で配分計算
- 4人揃わないと `start()` 不可

### config.yml
```yaml
sitandgo:
  enabled: true
  minBuyIn: 100
  ratingMinBuyIn: 100000
  maxPlayers: 4
  waitTimeSeconds: 60
  blindLevelSeconds: 180
  
  timeBank:
    defaultTime: 15
    additionalTime: 15
    additionalPerTurn: 5
    afkPenalty: 5
  
  multiplierTable:
    "2.5": 16.0
    "3.0": 14.5
    "3.5": 13.5
    "4.0": 37.0
    "5.0": 8.0
    "6.0": 4.0
    "8.0": 3.0
    "10.0": 2.0
    "15.0": 0.7
    "20.0": 0.3
  
  stackByMultiplier:
    "2.5": 20
    "3.0": 25
    "3.5": 30
    "4.0": 30
    "5.0": 35
    "6.0": 40
    "8.0": 50
    "10.0": 60
    "15.0": 80
    "20.0": 100
  
  blindStructure:
    - [1, 2, 2]
    - [1, 3, 3]
    - [2, 4, 4]
    - [3, 6, 6]
    - [5, 10, 10]
    - [7, 14, 14]
    - [10, 20, 20]
    - [15, 30, 30]
    - [20, 40, 40]
    - [30, 60, 60]
    - [40, 80, 80]
    - [50, 100, 100]
    - [70, 140, 140]
  
  rating:
    initialRating: 2500
    maxDisplayRating: 5000
    eloScale: 8250
    baseK: 80
    baseMinutes: 16.8
    protectionThreshold: 1000
```

## 検証項目
1. 100万回シミュレーションで期待値 ≈ 4.0 を確認
1.1 還元率 (RTP): 3.9825 / 4 = 0.9956 (≈99.56%) を確認
2. 最低保証（>= 2.5×buyIn）を全ケースで確認
3. Vault入出金処理の動作確認
4. 高倍率発生時のログ記録

## ブラインドストラクチャ（11レベル）

| Lv | SB / BB / BBA | 　時間　  | 2.5x(20BB) | 3.0x(25BB) | 4.0x(30BB) | 6.0x(40BB) | 10.0x(60BB) | 20.0x(100BB) |
| -: | ------------- | :-------: | ---------: | ---------: | ---------: | ---------: | ----------: | -----------: |
|  1 | 1 / 2 / 2     |   3分     |     20.0BB |     25.0BB |     30.0BB |     40.0BB |      60.0BB |      100.0BB |
|  2 | 1 / 3 / 3     |   3分     |     13.3BB |     16.7BB |     20.0BB |     26.7BB |      40.0BB |       66.7BB |
|  3 | 2 / 4 / 4     |   3分     |     10.0BB |     12.5BB |     15.0BB |     20.0BB |      30.0BB |       50.0BB |
|  4 | 3 / 6 / 6     |   3分     |      6.7BB |      8.3BB |     10.0BB |     13.3BB |      20.0BB |       33.3BB |
|  5 | 5 / 10 / 10   |   3分     |      4.0BB |      5.0BB |      6.0BB |      8.0BB |      12.0BB |       20.0BB |
|  6 | 7 / 14 / 14   |   3分     |      2.9BB |      3.6BB |      4.3BB |      5.7BB |       8.6BB |       14.3BB |
|  7 | 10 / 20 / 20  |   3分     |      2.0BB |      2.5BB |      3.0BB |      4.0BB |       6.0BB |       10.0BB |
|  8 | 15 / 30 / 30  |   3分     |      1.3BB |      1.7BB |      2.0BB |      2.7BB |       4.0BB |        6.7BB |
|  9 | 20 / 40 / 40  |   3分     |      1.0BB |      1.2BB |      1.5BB |      2.0BB |       3.0BB |        5.0BB |
| 10 | 30 / 60 / 60  |   3分     |      0.7BB |      0.8BB |      1.0BB |      1.3BB |       2.0BB |        3.3BB |
| 11 | 40 / 80 / 80  |   3分     |      0.5BB |      0.6BB |      0.8BB |      1.0BB |       1.5BB |        2.5BB |

- 上記ストラクチャを採用

## レーティングシステム（4人・ペアワイズElo＋2位最低+1保証）

### 基本仕様
- **初期内部レート**: 2500
- **内部レート下限**: 0（負の値は取らない）
- **表示レート**: `R_disp = clamp(R_int, 0, 5000)`
- **方式**: 4人戦を総当たり3ペア（ペアワイズ）として更新
- **同着処理**: 同タイミング飛びは「スタック少 → ポジション順」で一意に決定
- **レート変動条件**: **バイイン10万以上の試合のみ**レート変動が発生

### 期待勝率（Elo）
```
pᵢⱼ = 1 / (1 + 10^((Rⱼ - Rᵢ) / S))
S = 8250
```

### K値（試合時間ベース）
- **基準**: 30BB（T₃₀ = 16.8分）で K = 80
- **計算式**: `K(T) = 80 × √(T / 16.8)`

| 倍率 | BB | T(分) | K(T) |
|---:|---:|---:|---:|
| 2.5x | 20 | 13.9 | 66.2 |
| 3.0x | 25 | 15.0 | 71.4 |
| 3.5x | 30 | 16.8 | 80.0 |
| 4.0x | 30 | 16.8 | 80.0 |
| 5.0x | 35 | 18.0 | 85.7 |
| 6.0x | 40 | 19.3 | 91.9 |
| 8.0x | 50 | 21.0 | 100.0 |
| 10.0x | 60 | 22.5 | 107.1 |
| 15.0x | 80 | 24.8 | 118.1 |
| 20.0x | 100 | 27.0 | 128.6 |

### レート更新式（ペアワイズ）
```
ΔRᵢᵇᵃˢᵉ = K(T)/3 × Σⱼ≠ᵢ (sᵢⱼ - pᵢⱼ)
sᵢⱼ = 1 (iがjより上位), 0 (iがjより下位)
```

### 2位最低+1保証＋初心者保護
2位が確実に+1以上を獲得できるよう調整。

**Step A: 補正値 b の計算**
借金状態を防止
```
b = max(0, 1 - ΔR₂ᵇᵃˢᵉ)
```

**Step B: 最終変動**
```
ΔR₁ = ΔR₁ᵇᵃˢᵉ
ΔR₂ = ΔR₂ᵇᵃˢᵉ + b
ΔR₃ = ΔR₃ᵇᵃˢᵉ - cost₃
ΔR₄ = ΔR₄ᵇᵃˢᵉ - cost₄
```

**レート更新:**
```
R_int ← max(0, R_int + ΔR)
```

## 実装ファイル

### 新規作成（6ファイル）
- `game/SitAndGo.kt` - メインクラス
- `game/event/SitAndGo_Event.kt` - イベントハンドラ
- `game/utility/RouletteDisplay.kt` - ルーレット演出
- `game/command/SitAndGo_Command.kt` - コマンド処理
- `rating/SitAndGoRating.kt` - レート計算ロジック
- `rating/RatingRepository.kt` - レートDB操作

### 既存修正（4ファイル）
- `Main.kt` - テーブル追加、コマンド登録、イベント登録
- `Config.kt` - セクション取得メソッド追加
- `resources/config.yml` - sitandgoセクション追加
- `resources/plugin.yml` - コマンド追加

## コマンド
- `/sng start <金額>` - トーナメント開始
- `/sng join <ホスト名>` - 参加
- `/sng leave` - 離脱（募集中のみ）
- `/sng rating [プレイヤー]` - レート確認
- `/sng top` - ランキング

## TODO
- [ ] 重みテーブルの最終調整（期待値=4.0、4.0xを40%）
- [ ] `SitAndGo.kt` 実装
- [ ] シミュレーション作成
- [ ] レーティングシステム実装
- [ ] 本番投入前テスト
